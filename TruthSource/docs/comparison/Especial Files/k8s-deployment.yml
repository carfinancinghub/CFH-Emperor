# ----------------------------------------------------------------------
# File: k8s-deployment.yml
# Path: k8s/k8s-deployment.yml
# Author: Gemini & SG Man, System Architects
# Created: August 13, 2025 at 17:25 PDT
# Version: 1.0.1 (Enhanced with Frontend & Config)
# ðŸ‘‘ Cod1 Crown Certified
# ----------------------------------------------------------------------
#
# @description
# Kubernetes configuration for deploying the CFH platform to AWS EKS.
#
# @architectural_notes
# - **Scalable**: Defines deployments with autoscaling for backend and frontend.
# - **Secure**: Uses ConfigMap and Secret for configuration.
# - **Resilient**: Configures LoadBalancer services for high availability.
#
# @todos
# - @free:
#   - [x] Define backend and frontend deployments.
# - @premium:
#   - [ ] âœ¨ Add advanced autoscaling policies.
# - @wow:
#   - [ ] ðŸš€ Integrate AI-driven scaling predictions.
#
# ----------------------------------------------------------------------
apiVersion: v1
kind: ConfigMap
metadata:
  name: cfh-config
  namespace: cfh
data:
  NODE_ENV: "production"
  MONGO_URI: "mongodb://db:27017/cfh"
  REDIS_URL: "redis://redis:6379"
  VITE_API_BASE_URL: "http://backend:5000/api/v1"
---
apiVersion: v1
kind: Secret
metadata:
  name: cfh-secrets
  namespace: cfh
type: Opaque
data:
  JWT_SECRET: <base64-encoded-secret>
  AWS_ACCESS_KEY_ID: <base64-encoded-key>
  AWS_SECRET_ACCESS_KEY: <base64-encoded-secret>
  AWS_S3_BUCKET_NAME: <base64-encoded-bucket>
  STRIPE_SECRET_KEY: <base64-encoded-key>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cfh-backend-deployment
  namespace: cfh
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cfh-backend
  template:
    metadata:
      labels:
        app: cfh-backend
    spec:
      containers:
      - name: backend
        image: <your-ecr-registry>/cfh-backend-repo:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 5000
        envFrom:
        - configMapRef:
            name: cfh-config
        - secretRef:
            name: cfh-secrets
        livenessProbe:
          httpGet:
            path: /health
            port: 5000
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: cfh-backend-service
  namespace: cfh
spec:
  selector:
    app: cfh-backend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 5000
    name: http
  - protocol: TCP
    port: 9100
    targetPort: 9100
    name: metrics
  type: LoadBalancer
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cfh-backend-hpa
  namespace: cfh
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cfh-backend-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cfh-frontend-deployment
  namespace: cfh
spec:
  replicas: 3
  selector:
    matchLabels:
      app: cfh-frontend
  template:
    metadata:
      labels:
        app: cfh-frontend
    spec:
      containers:
      - name: frontend
        image: <your-ecr-registry>/cfh-frontend-repo:latest
        imagePullPolicy: Always
        ports:
        - containerPort: 3000
        envFrom:
        - configMapRef:
            name: cfh-config
        - secretRef:
            name: cfh-secrets
        livenessProbe:
          httpGet:
            path: /
            port: 3000
          initialDelaySeconds: 15
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: cfh-frontend-service
  namespace: cfh
spec:
  selector:
    app: cfh-frontend
  ports:
  - protocol: TCP
    port: 80
    targetPort: 3000
    name: http
  - protocol: TCP
    port: 9100
    targetPort: 9100
    name: metrics
  type: LoadBalancer
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: cfh-frontend-hpa
  namespace: cfh
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: cfh-frontend-deployment
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 80